{% extends 'layout.html' %}

{% block title %}Reviewer Approval - {{ conference.title }}{% endblock %}

{% block content %}
<div class="space-y-8 p-6 bg-white shadow-xl rounded-lg">

    <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h1 class="text-3xl font-bold text-gray-800">
            Reviewer Approval: <span class="text-yellow-600">{{ conference.title }}</span>
        </h1>
        <a href="{{ url_for('organizer.dashboard', conf_id=conference.conference_id) }}" class="text-sm text-gray-500 hover:text-indigo-600 transition duration-150 flex items-center">
            <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
        </a>
    </div>

    <div class="bg-yellow-50 p-4 rounded-lg shadow-sm flex justify-between items-center border border-yellow-300">
        <p class="text-lg font-medium text-yellow-800">
            Total Pending Requests: <span class="font-bold text-yellow-900">{{ roles | length }}</span>
        </p>
        <a href="{{ url_for('organizer.view_participants', conf_id=conference.conference_id, role_filter='reviewer') }}"
           class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition duration-150">
            View Approved Reviewers â†’
        </a>
    </div>

    {% if roles %}
    <div class="overflow-x-auto shadow border-b border-gray-200 sm:rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reviewer Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expertise / Notes</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for role in roles %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ role.user.name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ role.user.email }}
                    </td>

                    <td class="px-6 py-4 text-sm text-gray-500 max-w-sm">
                        {% set expertise_names = [] %}
                        {% if role.expertise %}
                            {# Split the comma-separated IDs (e.g., "1,2") #}
                            {% for track_id_str in role.expertise.split(',') %}
                                {% set name = track_lookup.get(track_id_str.strip()) %}
                                {% if name %}
                                    {# Append the found name to the list #}
                                    {% set _ = expertise_names.append(name) %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        {% if expertise_names %}
                            <p class="font-medium text-gray-800 mb-1">Expertise Tracks:</p>
                            <p class="text-xs text-indigo-600">
                                {{ expertise_names | join(' / ') }}
                            </p>
                        {% else %}
                            <p>No specific tracks selected.</p>
                        {% endif %}

                        {# You might also display additional notes here if stored in a separate column #}
                        {# <p class="text-xs mt-2">{{ role.additional_notes }}</p> #}

                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-3">

                        <form method="POST" action="{{ url_for('organizer.reviewer_action', conf_id=conference.conference_id, role_id=role.id, action='approve') }}" class="inline-block">
                            <button type="submit" class="text-white bg-green-600 hover:bg-green-700 py-1 px-3 rounded-md shadow-sm transition duration-150 text-xs font-semibold">
                                <i class="fas fa-check mr-1"></i> Approve
                            </button>
                        </form>

                        <form method="POST" action="{{ url_for('organizer.reviewer_action', conf_id=conference.conference_id, role_id=role.id, action='reject') }}"
                              onsubmit="return confirm('Are you sure you want to reject {{ role.user.name }} as a reviewer? Their role will be permanently deleted.')" class="inline-block ml-2">
                            <button type="submit" class="text-white bg-red-600 hover:bg-red-700 py-1 px-3 rounded-md shadow-sm transition duration-150 text-xs font-semibold">
                                <i class="fas fa-times mr-1"></i> Reject
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-10 bg-gray-50 rounded-lg border">
        <p class="text-lg text-gray-600">ðŸŽ‰ All reviewer requests have been handled!</p>
    </div>
    {% endif %}

</div>
{% endblock %}