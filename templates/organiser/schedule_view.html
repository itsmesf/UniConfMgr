{% extends 'layout.html' %}

{% block title %}Program Schedule - {{ conference.title }}{% endblock %}

{% block content %}

<div class="space-y-8 p-6 bg-white shadow-xl rounded-lg">
    <div class="flex justify-between items-center border-b pb-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">{{ conference.title }}</h1>
            <p class="mt-1 text-gray-600">Official Program Schedule</p>
        </div>

        <div class="flex space-x-3">

            <a href="{{ url_for('schedule.get_public_schedule_pdf', conf_id=conference.conference_id) }}"
               class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded transition duration-300 flex items-center shadow-md text-sm">
                <i class="fas fa-file-pdf mr-2"></i> Download Schedule (PDF)
            </a>


        </div>
    </div>

    {% for date, sessions_that_day in sessions_by_date.items() %}

        <h2 class="text-2xl font-bold text-teal-600 border-b pb-2 mt-6">
            {{ date | strftime('%A, %B %d, %Y') }}
        </h2>

        {% set tracks_that_day = sessions_that_day | groupby('track.name') %}

        {% for track_name, sessions_in_track in tracks_that_day %}

            {% set first_session = sessions_in_track | first %}
            {% set track = first_session.track %}
            <div class="border rounded-lg shadow-sm mb-6">

                <h3 class="text-xl font-semibold text-purple-700 bg-gray-50 p-3 border-l-4 border-purple-400">
                    {{ track.name if track else 'General Sessions' }}
                </h3>

                <div class="p-4 space-y-3">
                    {% for session in sessions_in_track | sort(attribute='schedule_time') %}
                        <div class="p-3 border rounded-md flex justify-between items-start hover:bg-indigo-50 transition">

                            <div class="w-1/4 text-sm font-medium text-gray-700">
                                {{ session.schedule_time | strftime('%I:%M %p') }}
                                <span class="text-xs text-gray-500 block">{{ session.location | default('TBD', True) }}</span>
                            </div>

                            <div class="w-3/4 pl-4">
                                <p class="text-base font-bold text-gray-800">{{ session.name }}</p>

                                {% if session.session_chair_role %}
                                    <p class="text-sm text-gray-600">Chair: {{ session.session_chair_role.user.name }}</p>
                                {% endif %}

                                {# CRITICAL: Display papers ONLY if session name is "Paper Presentation" #}
                                {% if session.name == "Paper Presentation" %}

                                    {% set confirmed_papers = [] %}
                                    {% for session_paper in session.papers_in_session %}
                                        {% set paper = session_paper.paper %}

                                        {# Check 1: Paper status must be accepted #}
                                        {% set is_accepted = paper.status.name == 'accepted' %}

                                        {# Check 2: Payment must be completed AND registration link must exist #}
                                        {% set is_paid = paper.author_role.registration_link and paper.author_role.registration_link.payment_status.name == 'completed' %}

                                        {% if is_accepted and is_paid %}
                                            {% set _ = confirmed_papers.append(paper) %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if confirmed_papers %}
                                        <ul class="list-disc list-inside text-sm mt-2 space-y-1 text-gray-700">
                                            {% for paper in confirmed_papers %}
                                                <li class="pl-2">
                                                    <span class="font-semibold text-xs text-green-600">ID: {{ paper.paper_id }}</span>
                                                    â€” <span class="font-medium">{{ paper.title }}</span>
                                                    <span class="text-xs text-gray-500">
                                                        (Author: {{ paper.author_role.user.name }})
                                                    </span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-xs text-gray-500 mt-1">No confirmed papers scheduled for this presentation slot.</p>
                                    {% endif %}

                                {% endif %}
                                {# End Paper Presentation conditional display #}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-10 bg-gray-50 rounded-lg">
            <p class="text-lg text-gray-600">No sessions have been scheduled yet.</p>
        </div>
    {% endfor %}

</div>
{% endblock %}